(function(){"use strict";var _=(u=>(u.CREATE_TASK="create_task",u.COMPLETE_TASK="complete_task",u.CANCEL_TASK="cancel_task",u.UPDATE_POINTS_COST="update_points_cost",u))(_||{});function b(u,e){return"z"in u?"z"in e?u.x===e.x&&u.y===e.y&&u.z===e.z:!1:u.x===e.x&&u.y===e.y}function M(u,e){Object.entries(u).forEach(([i,r],h)=>{e(i,r,h)})}function S(u,e){const i=e.x-u.x,r=e.y-u.y;return Math.sqrt(i*i+r*r)}function R(u,e,i){const r={x:u.x+e.x,y:u.y+e.y},h=i[r.y]?.[r.x]??1;return Math.abs(e.x)+Math.abs(e.y)!==1?h*Math.SQRT2+(i[u.y]?.[r.x]??0)+(i[r.y]?.[u.x]??0):h}function z(u,e){const i={},r={R:{x:1,y:0},L:{x:-1,y:0},D:{x:0,y:1},U:{x:0,y:-1}},h={RD:{x:1,y:1},RU:{x:1,y:-1},LU:{x:-1,y:-1},LD:{x:-1,y:1}},c=[];return M(r,(f,d)=>{const g=e.x+d.x,C=e.y+d.y;u[C]?.[g]===!1&&(i[f]=!0,c.push(d))}),M(h,(f,d)=>{const g=f.split("").every(O=>i[O]),C=e.x+d.x,D=e.y+d.y;g&&u[D]?.[C]===!1&&c.push(d)}),c}class U{constructor(){this.pointsCost=[],this.taskQueue=[]}createTask(e){this.taskQueue.push(e)}cancelTask(e){const i=this.taskQueue.findIndex(r=>r.id===e);i!==-1&&this.taskQueue.splice(i,1)}updatePointsCost(e){this.pointsCost=e}processing(){for(;this.taskQueue.length>0;){const e=this.taskQueue[0],i=e.takeLastNode();if(!i){this.taskQueue.shift(),e.failure();continue}if(b(e.to,i)){this.taskQueue.shift(),e.complete(i);continue}i.closeList(),z(e.grid,i).forEach(r=>{e.checkAdjacentNode(i,r,this.pointsCost)})}}}var q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function N(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var I={exports:{}};(function(u,e){(function(){var i,r,h,c,f,d,g,C,D,O,G,K,A,E,w;h=Math.floor,O=Math.min,r=function(t,s){return t<s?-1:t>s?1:0},D=function(t,s,n,o,p){var l;if(n==null&&(n=0),p==null&&(p=r),n<0)throw new Error("lo must be non-negative");for(o==null&&(o=t.length);n<o;)l=h((n+o)/2),p(s,t[l])<0?o=l:n=l+1;return[].splice.apply(t,[n,n-n].concat(s)),s},d=function(t,s,n){return n==null&&(n=r),t.push(s),E(t,0,t.length-1,n)},f=function(t,s){var n,o;return s==null&&(s=r),n=t.pop(),t.length?(o=t[0],t[0]=n,w(t,0,s)):o=n,o},C=function(t,s,n){var o;return n==null&&(n=r),o=t[0],t[0]=s,w(t,0,n),o},g=function(t,s,n){var o;return n==null&&(n=r),t.length&&n(t[0],s)<0&&(o=[t[0],s],s=o[0],t[0]=o[1],w(t,0,n)),s},c=function(t,s){var n,o,p,l,a,y;for(s==null&&(s=r),l=function(){y=[];for(var x=0,k=h(t.length/2);0<=k?x<k:x>k;0<=k?x++:x--)y.push(x);return y}.apply(this).reverse(),a=[],o=0,p=l.length;o<p;o++)n=l[o],a.push(w(t,n,s));return a},A=function(t,s,n){var o;if(n==null&&(n=r),o=t.indexOf(s),o!==-1)return E(t,0,o,n),w(t,o,n)},G=function(t,s,n){var o,p,l,a,y;if(n==null&&(n=r),p=t.slice(0,s),!p.length)return p;for(c(p,n),y=t.slice(s),l=0,a=y.length;l<a;l++)o=y[l],g(p,o,n);return p.sort(n).reverse()},K=function(t,s,n){var o,p,l,a,y,x,k,P,L;if(n==null&&(n=r),s*10<=t.length){if(l=t.slice(0,s).sort(n),!l.length)return l;for(p=l[l.length-1],k=t.slice(s),a=0,x=k.length;a<x;a++)o=k[a],n(o,p)<0&&(D(l,o,0,null,n),l.pop(),p=l[l.length-1]);return l}for(c(t,n),L=[],y=0,P=O(s,t.length);0<=P?y<P:y>P;0<=P?++y:--y)L.push(f(t,n));return L},E=function(t,s,n,o){var p,l,a;for(o==null&&(o=r),p=t[n];n>s;){if(a=n-1>>1,l=t[a],o(p,l)<0){t[n]=l,n=a;continue}break}return t[n]=p},w=function(t,s,n){var o,p,l,a,y;for(n==null&&(n=r),p=t.length,y=s,l=t[s],o=2*s+1;o<p;)a=o+1,a<p&&!(n(t[o],t[a])<0)&&(o=a),t[s]=t[o],s=o,o=2*s+1;return t[s]=l,E(t,y,s,n)},i=function(){t.push=d,t.pop=f,t.replace=C,t.pushpop=g,t.heapify=c,t.updateItem=A,t.nlargest=G,t.nsmallest=K;function t(s){this.cmp=s??r,this.nodes=[]}return t.prototype.push=function(s){return d(this.nodes,s,this.cmp)},t.prototype.pop=function(){return f(this.nodes,this.cmp)},t.prototype.peek=function(){return this.nodes[0]},t.prototype.contains=function(s){return this.nodes.indexOf(s)!==-1},t.prototype.replace=function(s){return C(this.nodes,s,this.cmp)},t.prototype.pushpop=function(s){return g(this.nodes,s,this.cmp)},t.prototype.heapify=function(){return c(this.nodes,this.cmp)},t.prototype.updateItem=function(s){return A(this.nodes,s,this.cmp)},t.prototype.clear=function(){return this.nodes=[]},t.prototype.empty=function(){return this.nodes.length===0},t.prototype.size=function(){return this.nodes.length},t.prototype.clone=function(){var s;return s=new t,s.nodes=this.nodes.slice(0),s},t.prototype.toArray=function(){return this.nodes.slice(0)},t.prototype.insert=t.prototype.push,t.prototype.top=t.prototype.peek,t.prototype.front=t.prototype.peek,t.prototype.has=t.prototype.contains,t.prototype.copy=t.prototype.clone,t}(),function(t,s){return u.exports=s()}(this,function(){return i})}).call(q)})(I);var j=I.exports,H=j,F=N(H);class Q{constructor(e,{position:i,cost:r=1,distance:h}){this.listOpened=null,this.x=i.x,this.y=i.y,this.distance=h,this.cost=r,this.parent=e}bestGuessDistance(){return this.cost+this.distance}getCost(){return this.cost}setCost(e){this.cost=e}getParent(){return this.parent}setParent(e){this.parent=e}isNewList(){return this.listOpened===null}isListOpened(){return this.listOpened===!0}openList(){this.listOpened=!0}closeList(){this.listOpened=!1}getPath(){const e=[{x:this.x,y:this.y}];let i=this.getParent();for(;i;)e.push({x:i.x,y:i.y}),i=i.getParent();return e.reverse(),e}}class v{constructor({id:e,from:i,to:r,grid:h,compress:c=!1}){this.tree=[],this.compress=!1,this.id=e,this.from=i,this.to=r,this.grid=h,this.compress=c,this.nodes=new F((d,g)=>d.bestGuessDistance()-g.bestGuessDistance());const f=new Q(null,{position:i,distance:S(i,r)});this.addNode(f)}takeLastNode(){return this.nodes.pop()??null}addNode(e){this.nodes.push(e),this.tree[e.y]||(this.tree[e.y]=[]),this.tree[e.y][e.x]=e}pickNode(e){return this.tree[e.y]?.[e.x]}upNode(e){this.nodes.updateItem(e)}failure(){self.postMessage({event:_.COMPLETE_TASK,payload:{id:this.id,path:null}})}complete(e){let i=e.getPath();this.compress&&(i=v.CompressPath(i)),self.postMessage({event:_.COMPLETE_TASK,payload:{id:this.id,path:i}})}checkAdjacentNode(e,i,r){const h={x:e.x+i.x,y:e.y+i.y},c=e.getCost()+R(e,i,r),f=this.pickNode(h);if(f)c<f.getCost()&&(f.setCost(c),f.setParent(e),this.upNode(f));else{const d=new Q(e,{position:h,cost:c,distance:S(h,this.to)});d.openList(),this.addNode(d)}}static CompressPath(e){if(e.length<3)return e;const i=[],r={...e[0]};let h={...e[1]},c={x:0,y:0};c=v.GetDirection(h,r),i.push(r);for(let f=2;f<e.length;f++){const d={...h},g={...c};h={...e[f]},c=v.GetDirection(h,d),b(c,g)||i.push(d)}return i.push(h),i}static GetDirection(e,i){const r={x:e.x-i.x,y:e.y-i.y},h=Math.sqrt(r.x**2+r.y**2);return r.x/=h,r.y/=h,r}}const T=new U;setInterval(()=>{T.processing()},100),self.onmessage=({data:u})=>{switch(u.event){case _.CREATE_TASK:const e=new v(u.payload);T.createTask(e);break;case _.CANCEL_TASK:T.cancelTask(u.payload.id);break;case _.UPDATE_POINTS_COST:T.updatePointsCost(u.payload);break}}})();
